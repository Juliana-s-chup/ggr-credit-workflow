{% extends "suivi_demande/dashboard_base.html" %}
{% load static %}

{% block title %}Dashboard Responsable GGR{% endblock %}

{% block dashboard_role %}Responsable GGR{% endblock %}

{% block user_role %}Responsable GGR{% endblock %}

{% block page_title %}Gestion des Risques{% endblock %}

{% block header_icon %}fas fa-shield-alt{% endblock %}

{% block navigation %}
<a href="#" class="nav-item-banking active" data-section="dashboard">
    <i class="fas fa-tachometer-alt"></i>
    <span>Tableau de Bord</span>
</a>
<a href="#" class="nav-item-banking" data-section="dossiers">
    <i class="fas fa-folder"></i>
    <span>Dossiers à Valider</span>
    <span class="badge badge-warning ml-auto">{{ dossiers_a_valider|length|default:6 }}</span>
</a>
<a href="#" class="nav-item-banking" data-section="decisions">
    <i class="fas fa-gavel"></i>
    <span>Mes Décisions</span>
    <span class="badge badge-success ml-auto">{{ decisions_prises|default:23 }}</span>
</a>
<a href="#" class="nav-item-banking" data-section="risques">
    <i class="fas fa-exclamation-triangle"></i>
    <span>Analyse Risques</span>
</a>
<a href="#" class="nav-item-banking" data-section="rapports">
    <i class="fas fa-chart-pie"></i>
    <span>Rapports GGR</span>
</a>
{% endblock %}

{% block stats_cards %}
<div class="kpi-card">
    <div class="kpi-value">{{ dossiers_a_valider|length|default:6 }}</div>
    <div class="kpi-label">À Valider</div>
    <div class="text-xs text-warning mt-2">
        <i class="fas fa-clock"></i> Échéance proche: 2
    </div>
</div>

<div class="kpi-card">
    <div class="kpi-value">{{ decisions_ce_mois|default:18 }}</div>
    <div class="kpi-label">Décisions ce Mois</div>
    <div class="text-xs text-success mt-2">
        <i class="fas fa-check"></i> Approuvées: {{ approuvees_mois|default:14 }}
    </div>
</div>

<div class="kpi-card">
    <div class="kpi-value">{{ taux_approbation|default:78 }}%</div>
    <div class="kpi-label">Taux d'Approbation</div>
    <div class="text-xs text-info mt-2">
        <i class="fas fa-chart-line"></i> Tendance stable
    </div>
</div>

<div class="kpi-card">
    <div class="kpi-value">{{ exposition_totale|default:"45.2M" }}</div>
    <div class="kpi-label">Exposition Totale</div>
    <div class="text-xs text-primary mt-2">
        <i class="fas fa-coins"></i> FCFA
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Section Dashboard -->
<section class="content-section active" id="dashboard-section">
    <div class="stats-grid mb-8">
        {% block stats_cards %}{% endblock %}
    </div>
    
    <div class="grid md:grid-cols-2 gap-6 mb-8">
        <!-- Dossiers Prioritaires -->
        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-semibold flex items-center gap-2">
                    <i class="fas fa-star text-warning"></i>
                    Dossiers Prioritaires
                </h3>
            </div>
            <div class="card-body">
                {% for dossier in dossiers_prioritaires|slice:":5" %}
                <div class="flex items-center justify-between p-4 border-l-4 border-error bg-red-50 rounded mb-3">
                    <div>
                        <div class="font-semibold text-primary">{{ dossier.reference }}</div>
                        <div class="text-sm text-muted">{{ dossier.client.get_full_name }}</div>
                        <div class="text-xs text-error">
                            <i class="fas fa-exclamation-triangle"></i> 
                            Montant: {{ dossier.montant|floatformat:0 }} FCFA
                        </div>
                    </div>
                    <div class="flex flex-col gap-2">
                        <span class="badge badge-error">Risque Élevé</span>
                        <button class="btn btn-primary btn-sm">
                            <i class="fas fa-gavel"></i> Décider
                        </button>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-8 text-muted">
                    <i class="fas fa-check-circle text-success text-3xl mb-4"></i>
                    <p>Aucun dossier prioritaire</p>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Alertes Risques -->
        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-semibold flex items-center gap-2">
                    <i class="fas fa-bell text-error"></i>
                    Alertes Risques
                </h3>
            </div>
            <div class="card-body">
                <div class="space-y-4">
                    <div class="flex items-start gap-3">
                        <div class="w-2 h-2 bg-error rounded-full mt-2"></div>
                        <div class="flex-1">
                            <div class="text-sm font-medium">Exposition secteur immobilier</div>
                            <div class="text-xs text-muted">Seuil de 30% atteint • Il y a 2h</div>
                        </div>
                    </div>
                    <div class="flex items-start gap-3">
                        <div class="w-2 h-2 bg-warning rounded-full mt-2"></div>
                        <div class="flex-1">
                            <div class="text-sm font-medium">Client à risque détecté</div>
                            <div class="text-xs text-muted">Score de crédit dégradé • Il y a 4h</div>
                        </div>
                    </div>
                    <div class="flex items-start gap-3">
                        <div class="w-2 h-2 bg-info rounded-full mt-2"></div>
                        <div class="flex-1">
                            <div class="text-sm font-medium">Nouveau seuil réglementaire</div>
                            <div class="text-xs text-muted">Mise à jour COBAC • Hier</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Métriques Avancées -->
    <div class="grid lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2">
            <div class="card">
                <div class="card-header">
                    <h3 class="text-lg font-semibold">Évolution du Portefeuille</h3>
                </div>
                <div class="card-body">
                    <div class="h-64 flex items-center justify-center bg-gray-50 rounded">
                        <div class="text-center text-muted">
                            <i class="fas fa-chart-area text-4xl mb-4"></i>
                            <p>Graphique d'évolution du portefeuille</p>
                            <p class="text-xs">(Exposition par secteur et évolution temporelle)</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-semibold">Répartition Risques</h3>
            </div>
            <div class="card-body">
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <span class="text-sm">Faible Risque</span>
                        <div class="flex items-center gap-2">
                            <div class="w-20 h-2 bg-gray-200 rounded">
                                <div class="w-3/5 h-full bg-success rounded"></div>
                            </div>
                            <span class="text-xs font-medium">60%</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm">Risque Moyen</span>
                        <div class="flex items-center gap-2">
                            <div class="w-20 h-2 bg-gray-200 rounded">
                                <div class="w-1/4 h-full bg-warning rounded"></div>
                            </div>
                            <span class="text-xs font-medium">25%</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm">Risque Élevé</span>
                        <div class="flex items-center gap-2">
                            <div class="w-20 h-2 bg-gray-200 rounded">
                                <div class="w-1/6 h-full bg-error rounded"></div>
                            </div>
                            <span class="text-xs font-medium">15%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Section Dossiers à Valider -->
<section class="content-section" id="dossiers-section">
    <div class="card">
        <div class="card-header">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-semibold">Dossiers en Attente de Validation</h3>
                <div class="flex gap-2">
                    <select class="form-input text-sm">
                        <option>Tous les risques</option>
                        <option>Risque faible</option>
                        <option>Risque moyen</option>
                        <option>Risque élevé</option>
                    </select>
                    <button class="btn btn-secondary btn-sm">
                        <i class="fas fa-sort"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-gray-200">
                            <th class="text-left py-3 px-4 font-semibold">Référence</th>
                            <th class="text-left py-3 px-4 font-semibold">Client</th>
                            <th class="text-left py-3 px-4 font-semibold">Montant</th>
                            <th class="text-left py-3 px-4 font-semibold">Score Risque</th>
                            <th class="text-left py-3 px-4 font-semibold">Analyste</th>
                            <th class="text-left py-3 px-4 font-semibold">Échéance</th>
                            <th class="text-left py-3 px-4 font-semibold">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for dossier in dossiers_a_valider %}
                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                            <td class="py-4 px-4">
                                <span class="font-medium text-primary">{{ dossier.reference }}</span>
                                <div class="text-xs text-muted">{{ dossier.date_soumission|date:"d/m/Y" }}</div>
                            </td>
                            <td class="py-4 px-4">
                                <div class="font-medium">{{ dossier.client.get_full_name }}</div>
                                <div class="text-xs text-muted">{{ dossier.produit }}</div>
                            </td>
                            <td class="py-4 px-4">
                                <span class="font-semibold">{{ dossier.montant|floatformat:0 }} FCFA</span>
                            </td>
                            <td class="py-4 px-4">
                                {% if dossier.score_risque >= 80 %}
                                    <span class="badge badge-error">{{ dossier.score_risque|default:85 }}/100</span>
                                {% elif dossier.score_risque >= 60 %}
                                    <span class="badge badge-warning">{{ dossier.score_risque|default:72 }}/100</span>
                                {% else %}
                                    <span class="badge badge-success">{{ dossier.score_risque|default:45 }}/100</span>
                                {% endif %}
                            </td>
                            <td class="py-4 px-4">
                                <div class="text-sm">{{ dossier.analyste_assigne.get_full_name|default:"Non assigné" }}</div>
                            </td>
                            <td class="py-4 px-4">
                                <div class="text-sm">{{ dossier.date_echeance|date:"d/m/Y"|default:"Aujourd'hui" }}</div>
                            </td>
                            <td class="py-4 px-4">
                                <div class="flex gap-2">
                                    <button class="btn btn-success btn-sm" onclick="approuverDossier('{{ dossier.pk }}')">
                                        <i class="fas fa-check"></i> Approuver
                                    </button>
                                    <button class="btn btn-error btn-sm" onclick="rejeterDossier('{{ dossier.pk }}')">
                                        <i class="fas fa-times"></i> Rejeter
                                    </button>
                                    <button class="btn btn-secondary btn-sm">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="py-12 text-center text-muted">
                                <i class="fas fa-inbox text-4xl mb-4"></i>
                                <p>Aucun dossier en attente de validation</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>

<!-- Section Décisions -->
<section class="content-section" id="decisions-section">
    <div class="card">
        <div class="card-header">
            <h3 class="text-lg font-semibold">Historique de mes Décisions</h3>
        </div>
        <div class="card-body">
            <div class="space-y-4">
                {% for decision in mes_decisions|slice:":10" %}
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="font-semibold text-primary">{{ decision.dossier.reference }}</h4>
                            <p class="text-sm text-muted">{{ decision.dossier.client.get_full_name }}</p>
                        </div>
                        {% if decision.decision == 'APPROUVE' %}
                            <span class="status-banking status-approved">Approuvé</span>
                        {% else %}
                            <span class="status-banking status-rejected">Rejeté</span>
                        {% endif %}
                    </div>
                    <div class="grid md:grid-cols-4 gap-4 text-sm">
                        <div>
                            <span class="text-muted">Montant:</span>
                            <span class="font-semibold ml-2">{{ decision.dossier.montant|floatformat:0 }} FCFA</span>
                        </div>
                        <div>
                            <span class="text-muted">Score:</span>
                            <span class="font-semibold ml-2">{{ decision.score_risque|default:"N/A" }}/100</span>
                        </div>
                        <div>
                            <span class="text-muted">Date:</span>
                            <span class="font-semibold ml-2">{{ decision.date_decision|date:"d/m/Y" }}</span>
                        </div>
                        <div>
                            <span class="text-muted">Délai:</span>
                            <span class="font-semibold ml-2">{{ decision.delai_traitement|default:2 }}j</span>
                        </div>
                    </div>
                    {% if decision.commentaire %}
                    <div class="mt-3 p-3 bg-gray-50 rounded text-sm">
                        <strong>Commentaire:</strong> {{ decision.commentaire }}
                    </div>
                    {% endif %}
                </div>
                {% empty %}
                <div class="text-center py-12 text-muted">
                    <i class="fas fa-gavel text-4xl mb-4"></i>
                    <p>Aucune décision récente</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</section>

<!-- Section Analyse Risques -->
<section class="content-section" id="risques-section">
    <div class="grid md:grid-cols-2 gap-6">
        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-semibold">Matrice des Risques</h3>
            </div>
            <div class="card-body">
                <div class="h-64 flex items-center justify-center bg-gray-50 rounded">
                    <div class="text-center text-muted">
                        <i class="fas fa-th text-4xl mb-4"></i>
                        <p>Matrice Probabilité/Impact</p>
                        <p class="text-xs">(Visualisation des risques par quadrant)</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-semibold">Indicateurs de Risque</h3>
            </div>
            <div class="card-body">
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-sm">Ratio de Solvabilité</span>
                        <span class="font-semibold text-success">12.5%</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm">Taux de Défaut</span>
                        <span class="font-semibold text-warning">2.1%</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm">Concentration Sectorielle</span>
                        <span class="font-semibold text-info">28%</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm">Provisions Constituées</span>
                        <span class="font-semibold text-success">95%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Section Rapports -->
<section class="content-section" id="rapports-section">
    <div class="grid md:grid-cols-2 gap-6">
        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-semibold">Rapports Réglementaires</h3>
            </div>
            <div class="card-body">
                <div class="space-y-3">
                    <button class="btn btn-primary w-full text-left">
                        <i class="fas fa-file-alt mr-2"></i>
                        Rapport COBAC Mensuel
                    </button>
                    <button class="btn btn-primary w-full text-left">
                        <i class="fas fa-chart-pie mr-2"></i>
                        Analyse de Portefeuille
                    </button>
                    <button class="btn btn-primary w-full text-left">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Rapport de Risques
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-semibold">Rapports Récents</h3>
            </div>
            <div class="card-body">
                <div class="space-y-3">
                    <div class="flex items-center justify-between p-3 border border-gray-200 rounded">
                        <div>
                            <div class="font-medium">Rapport COBAC - Novembre</div>
                            <div class="text-xs text-muted">Généré le 30/11/2024</div>
                        </div>
                        <button class="btn btn-secondary btn-sm">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                    <div class="flex items-center justify-between p-3 border border-gray-200 rounded">
                        <div>
                            <div class="font-medium">Analyse Risques Q4</div>
                            <div class="text-xs text-muted">Généré le 25/11/2024</div>
                        </div>
                        <button class="btn btn-secondary btn-sm">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
function approuverDossier(dossierId) {
    if (confirm('Êtes-vous sûr de vouloir approuver ce dossier ?')) {
        console.log('Approbation du dossier:', dossierId);
        // Logique d'approbation
    }
}

function rejeterDossier(dossierId) {
    const motif = prompt('Motif du rejet:');
    if (motif) {
        console.log('Rejet du dossier:', dossierId, 'Motif:', motif);
        // Logique de rejet
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Animation des KPI avec gestion des pourcentages et unités
    const kpiValues = document.querySelectorAll('.kpi-value');
    kpiValues.forEach(value => {
        const text = value.textContent;
        const match = text.match(/(\d+(?:\.\d+)?)/);
        if (match) {
            const number = parseFloat(match[1]);
            let current = 0;
            const increment = number / 40;
            const timer = setInterval(() => {
                current += increment;
                if (current >= number) {
                    current = number;
                    clearInterval(timer);
                }
                const formatted = number % 1 === 0 ? Math.floor(current) : current.toFixed(1);
                value.textContent = text.replace(match[1], formatted);
            }, 30);
        }
    });
});
{% endblock %}
