{% extends "suivi_demande/dashboard_base.html" %}
{% load static %}
{% load dashboard_filters %}

{% block title %}Dashboard Client{% endblock %}
{% block dashboard_role %}Espace Client{% endblock %}
{% block user_role %}Client{% endblock %}
{% block page_title %}Mon Espace Personnel{% endblock %}
{% block header_icon %}fas fa-user-circle{% endblock %}

{% block extra_css %}
{# CSS inline supprimé - Utilise design-system.css et modern-dashboard.css #}
{% endblock %}

{% block navigation %}
<a href="#" class="nav-item-banking active" data-section="dashboard">
    <i class="fas fa-tachometer-alt"></i>
    <span>Tableau de Bord</span>
</a>
<a href="#" class="nav-item-banking" data-section="dossiers">
    <i class="fas fa-folder-open"></i>
    <span>Dossiers en Cours</span>
    <span class="badge badge-info ml-auto">{{ dossiers_en_cours|length }}</span>
</a>
<a href="#" class="nav-item-banking" data-section="dossiers-traites">
    <i class="fas fa-check-circle"></i>
    <span>Dossiers Traités</span>
    <span class="badge badge-success ml-auto">{{ dossiers_traites|length }}</span>
</a>
<a href="#" class="nav-item-banking" data-section="historique">
    <i class="fas fa-history"></i>
    <span>Historique</span>
    <span class="badge badge-secondary ml-auto">{{ historique_actions|length }}</span>
</a>
<a href="#" class="nav-item-banking" data-section="profil">
    <i class="fas fa-user-cog"></i>
    <span>Mon Profil</span>
</a>
{% endblock %}

{% block stats_cards %}
<div class="kpi-card">
    <div class="kpi-value">{{ mes_dossiers|length }}</div>
    <div class="kpi-label">Mes Dossiers</div>
</div>
<div class="kpi-card">
    <div class="kpi-value">{{ dossiers_approuves|default:0 }}</div>
    <div class="kpi-label">Approuvés</div>
</div>
<div class="kpi-card">
    <div class="kpi-value">{{ montant_total|default:0|floatformat:0 }} FCFA</div>
    <div class="kpi-label">Montant Total</div>
</div>
<div class="kpi-card">
    <div class="kpi-value">{{ unread_notifications_count|default:0 }}</div>
    <div class="kpi-label">Notifications</div>
</div>
{% endblock %}

{% block content %}
<!-- Dashboard Section -->
<section class="content-section active" id="dashboard-section">
    <!-- Échéances à venir (alertes) -->
    {% if echeances_a_venir %}
    <div class="card mb-6">
        <div class="card-header">
            <h3 class="text-lg font-semibold">
                <i class="fas fa-calendar-check"></i> Échéances à Venir (7 jours)
            </h3>
        </div>
        <div class="card-body">
            <div class="grid-auto">
                {% for echeance in echeances_a_venir %}
                {% with days_until=echeance.date_echeance|days_until %}
                <div class="card {% if days_until < 0 %}card-danger{% elif days_until <= 3 %}card-warning{% else %}card-primary{% endif %}">
                    <div class="card-body">
                        <div class="flex-between mb-4">
                            <div>
                                <h4 style="font-weight: bold; font-size: 1.125rem;">{{ echeance.dossier.reference }}</h4>
                                <p class="text-sm text-muted">{{ echeance.dossier.produit }}</p>
                            </div>
                            <span class="badge {% if days_until < 0 %}badge-danger{% elif days_until <= 3 %}badge-warning{% else %}badge-info{% endif %}">
                                {% if days_until < 0 %}
                                    Retard ({{ days_until|abs }}j)
                                {% elif days_until <= 3 %}
                                    Urgent
                                {% else %}
                                    {{ days_until }} jours
                                {% endif %}
                            </span>
                        </div>
                        <div class="grid-2col text-sm">
                            <div>
                                <div class="text-muted">Date d'échéance</div>
                                <div class="font-bold">{{ echeance.date_echeance|date:"d/m/Y" }}</div>
                            </div>
                            <div>
                                <div class="text-muted">Montant</div>
                                <div class="font-bold text-primary">{{ echeance.montant_echeance|floatformat:0 }} FCFA</div>
                            </div>
                        </div>
                        <div style="margin-top: 0.75rem;">
                            <a href="{% url 'client:dossier_detail' echeance.dossier.pk %}" class="btn btn-sm btn-primary">
                                <i class="fas fa-eye"></i> Voir le dossier
                            </a>
                        </div>
                    </div>
                </div>
                {% endwith %}
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    
    <div class="grid-auto-lg">
        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-semibold">Dossiers Récents</h3>
            </div>
            <div class="card-body">
                {% if dossiers %}
                  {% for d in dossiers|slice:':3' %}
                    <div class="card-nested">
                        <a href="{% url 'client:dossier_detail' d.pk %}" class="font-bold text-primary">{{ d.reference }}</a>
                        <div class="text-sm text-muted">{{ d.produit }}</div>
                        <div class="flex-between" style="margin-top: 0.5rem;">
                            <span class="badge {% if d.statut_client == 'APPROUVE' %}badge-success{% elif d.statut_client == 'REFUSE' %}badge-danger{% else %}badge-info{% endif %}">{{ d.get_statut_client_display }}</span>
                            <span class="font-bold text-primary" style="font-size: 1.125rem;">{{ d.montant|floatformat:0 }} <span class="text-xs">FCFA</span></span>
                        </div>
                    </div>
                  {% endfor %}
                {% else %}
                  <div class="text-muted">Aucun dossier récent.</div>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-semibold">Suivi d'avancement</h3>
            </div>
            <div class="card-body">
                {% if journal_recent %}
                <ul style="list-style: disc; padding-left: 1.25rem;">
                    {% for j in journal_recent %}
                    <li style="margin-bottom: 0.5rem;">
                        <div style="font-size: 0.875rem;">
                            <span style="font-weight: 600;">{{ j.dossier.reference }}</span> — <span style="text-transform: uppercase;">{{ j.action }}</span>
                            <span style="color: var(--text-secondary);"> • {{ j.timestamp|date:"d/m/Y H:i" }}</span>
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">{{ j.de_statut }} → {{ j.vers_statut }}</div>
                        {% if j.commentaire_systeme %}
                        <div style="font-size: 0.75rem;">{{ j.commentaire_systeme }}</div>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <div style="color: var(--text-secondary);">Aucune mise à jour récente.</div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<!-- Section Dossiers Traités -->
<section class="content-section" id="dossiers-traites-section">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h3 class="text-lg font-semibold mb-0"><i class="fas fa-check-circle me-2 text-success"></i>Mes Dossiers Traités</h3>
            <span class="badge bg-secondary">{{ dossiers_traites|length }}</span>
        </div>
        <div class="card-body">
            {% if dossiers_traites %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Référence</th>
                            <th>Produit</th>
                            <th>Montant</th>
                            <th>Statut</th>
                            <th>Date MAJ</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for d in dossiers_traites %}
                        <tr>
                            <td><a href="{% url 'client:dossier_detail' d.pk %}" class="text-primary fw-semibold">{{ d.reference }}</a></td>
                            <td>{{ d.produit }}</td>
                            <td><strong>{{ d.montant|floatformat:0 }} FCFA</strong></td>
                            <td>
                                {% if d.statut_client == 'APPROUVE' %}
                                <span class="badge bg-success"><i class="fas fa-check"></i> Approuvé</span>
                                {% elif d.statut_client == 'REFUSE' %}
                                <span class="badge bg-danger"><i class="fas fa-times"></i> Refusé</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ d.get_statut_client_display }}</span>
                                {% endif %}
                            </td>
                            <td><small>{{ d.date_maj|date:"d/m/Y H:i" }}</small></td>
                            <td>
                                <a href="{% url 'client:dossier_detail' d.pk %}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted mb-0">Aucun dossier traité pour le moment.</p>
            {% endif %}
        </div>
    </div>
</section>

<!-- Section Historique -->
<section class="content-section" id="historique-section">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h3 class="text-lg font-semibold mb-0"><i class="fas fa-history me-2 text-info"></i>Historique de mes Demandes</h3>
            <span class="badge bg-secondary">{{ historique_actions|length }}</span>
        </div>
        <div class="card-body">
            {% if historique_actions %}
            <ul class="list-group list-group-flush">
                {% for action in historique_actions %}
                <li class="list-group-item d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center gap-2 mb-1">
                            <span class="badge bg-primary">{{ action.action }}</span>
                            <a href="{% url 'client:dossier_detail' action.dossier.pk %}" class="text-primary fw-semibold">{{ action.dossier.reference }}</a>
                        </div>
                        <div class="small text-muted">
                            {% if action.commentaire_systeme %}
                            {{ action.commentaire_systeme }}
                            {% endif %}
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="small text-muted">{{ action.timestamp|date:"d/m/Y H:i" }}</div>
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-muted mb-0">Aucune action enregistrée.</p>
            {% endif %}
        </div>
    </div>
</section>

<!-- Mes Dossiers Section (cards) -->
<section class="content-section" id="dossiers-section">
    <div class="card">
        <div class="card-header">
            <h3 class="text-lg font-semibold">Mes Dossiers en Cours</h3>
            <p class="text-sm text-muted mb-0">Demandes en cours de traitement</p>
        </div>
        <div class="card-body">
            {% if mes_dossiers %}
            <div class="grid-auto">
                {% for d in mes_dossiers %}
                <div class="card" style="border-left-color: var(--client-primary);">
                    <div class="card-body">
                        <div class="flex-between">
                            <a href="{% url 'client:dossier_detail' d.pk %}" class="font-bold text-primary" style="text-decoration:none; font-size:1.05rem;">{{ d.reference }}</a>
                            <span class="badge {% if d.statut_client == 'TERMINE' %}badge-success{% elif d.statut_client == 'SE_RAPPROCHER_GEST' %}badge-warning{% else %}badge-info{% endif %}">
                                {{ d.get_statut_client_display }}
                            </span>
                        </div>
                        <div class="text-sm text-muted">{{ d.produit }}</div>
                        <div class="flex-between" style="margin-top: .5rem;">
                            <div class="text-primary" style="font-weight:700; font-size:1.125rem;">{{ d.montant|floatformat:0 }} <span class="text-xs">FCFA</span></div>
                            <div class="text-xs text-muted">Soumis le {{ d.date_soumission|date:"d/m/Y" }}</div>
                        </div>
                        <div style="margin-top:.75rem;">
                            <a class="btn btn-primary btn-sm" href="{% url 'client:dossier_detail' d.pk %}"><i class="fas fa-eye"></i> Ouvrir</a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="fas fa-folder-open fa-2x text-muted mb-2" style="display:block;"></i>
                <span class="text-muted">Aucun dossier en cours</span>
            </div>
            {% endif %}
        </div>
    </div>
    
</section>

<!-- Historique Section -->
<section class="content-section" id="historique-section">
    <div class="card">
        <div class="card-header">
            <h3 class="text-lg font-semibold">Historique de mes demandes traitées</h3>
            <p class="text-sm text-muted mb-0">Dossiers terminés et archivés</p>
        </div>
        <div class="card-body">
            {% if historique_dossiers %}
            <div class="grid-auto">
                {% for d in historique_dossiers %}
                <div class="card" style="border-left-color: var(--client-success);">
                    <div class="card-body">
                        <div class="flex-between">
                            <a href="{% url 'client:dossier_detail' d.pk %}" class="font-bold text-primary" style="text-decoration:none;">{{ d.reference }}</a>
                            <span class="badge badge-success"><i class="fas fa-check-circle"></i> {{ d.get_statut_client_display }}</span>
                        </div>
                        <div class="text-sm text-muted">{{ d.produit }}</div>
                        <div class="flex-between" style="margin-top:.5rem;">
                            <div class="text-primary" style="font-weight:700;">{{ d.montant|floatformat:0 }} <span class="text-xs">FCFA</span></div>
                            <div class="text-xs text-muted">Terminé le {{ d.date_maj|date:"d/m/Y" }}</div>
                        </div>
                        <div style="margin-top:.75rem;">
                            <a class="btn btn-sm btn-outline-primary" href="{% url 'client:dossier_detail' d.pk %}"><i class="fas fa-eye"></i> Consulter</a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <p class="text-muted">Aucun dossier terminé pour le moment.</p>
            </div>
            {% endif %}
        </div>
    </div>
</section>

<!-- Nouvelle Demande Section supprimée pour lecture seule côté Client -->

<!-- Profil Section -->
<section class="content-section" id="profil-section">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-semibold">Informations Personnelles</h3>
            </div>
            <div class="card-body">
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">Nom complet</div>
                        <div style="font-weight: 600;">{{ user.get_full_name|default:user.username }}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">Email</div>
                        <div style="font-weight: 600;">{{ user.email|default:"—" }}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">Téléphone</div>
                        <div style="font-weight: 600;">{{ user.profile.phone|default:"—" }}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">Adresse</div>
                        <div style="font-weight: 600;">{{ user.profile.address|default:"—" }}</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-semibold">Sécurité</h3>
            </div>
            <div class="card-body">
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <button class="btn btn-secondary" style="width: 100%;">
                        <i class="fas fa-key"></i> Changer le mot de passe
                    </button>
                    <button class="btn btn-secondary" style="width: 100%;">
                        <i class="fas fa-shield-alt"></i> Authentification à deux facteurs
                    </button>
                    <button class="btn btn-secondary" style="width: 100%;">
                        <i class="fas fa-bell"></i> Préférences de notifications
                    </button>
                </div>
                
                <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-light); border-radius: var(--radius-md);">
                    <h4 style="font-weight: 600; margin-bottom: 0.5rem;">Dernière connexion</h4>
                    <p style="font-size: 0.875rem; color: var(--text-secondary);">{{ user.last_login|date:"d/m/Y H:i"|default:"—" }}</p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Notification Modal -->
<div id="notif-modal" class="notif-modal">
    <div class="notif-modal-content">
        <div class="card">
            <div class="card-header flex justify-between items-center">
                <h3 class="text-lg font-semibold" id="notif-modal-title">Notification</h3>
                <button class="btn btn-secondary btn-sm" data-close="notif-modal"><i class="fas fa-times"></i></button>
            </div>
            <div class="card-body">
                <div class="text-sm text-muted mb-2" id="notif-modal-meta"></div>
                <div id="notif-modal-content" class="prose max-w-none"></div>
            </div>
            <div class="card-footer flex justify-end gap-2">
                <button class="btn btn-secondary" data-close="notif-modal">Fermer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
