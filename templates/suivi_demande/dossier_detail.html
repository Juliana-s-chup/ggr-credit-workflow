{% extends "base.html" %}
{% block title %}Dossier {{ dossier.reference }}{% endblock %}
{% block content %}
<h1 class="h4 mb-3">Dossier {{ dossier.reference }}</h1>

<div class="row g-3">
  <div class="col-12">
    <div class="card">
      <div class="card-body d-flex flex-wrap gap-2">
        <a class="btn btn-sm btn-outline-primary" href="{% url 'dossier_proposition_pdf' dossier.pk %}" target="_blank">Télécharger la proposition (PDF)</a>
        {% if can_tx_transmettre_analyste %}
          <form method="post" action="{% url 'transition_dossier' dossier.pk 'transmettre_analyste' %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-primary">Transmettre à l'analyste</button>
          </form>
        {% endif %}
        {% if can_tx_retour_client %}
          <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#retourClientModal" data-dossier-id="{{ dossier.pk }}">
            <i class="fas fa-undo me-1"></i> Retourner au client
          </button>
        {% endif %}
        {% if can_tx_transmettre_ggr %}
          <form method="post" action="{% url 'transition_dossier' dossier.pk 'transmettre_ggr' %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-primary">Transmettre GGR</button>
          </form>
        {% endif %}
        {% if can_tx_retour_gestionnaire %}
          <form method="post" action="{% url 'transition_dossier' dossier.pk 'retour_gestionnaire' %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-outline-secondary">Retour gestionnaire</button>
          </form>
        {% endif %}
        {% if can_tx_approuver %}
          <form method="post" action="{% url 'transition_dossier' dossier.pk 'approuver' %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-primary">Approuver</button>
          </form>
        {% endif %}
        {% if can_tx_refuser %}
          <form method="post" action="{% url 'transition_dossier' dossier.pk 'refuser' %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-outline-danger">Refuser</button>
          </form>
        {% endif %}
        {% if can_tx_liberer_fonds %}
          <form method="post" action="{% url 'transition_dossier' dossier.pk 'liberer_fonds' %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-primary">Libérer les fonds</button>
          </form>
        {% endif %}
        {% if not can_tx_transmettre_analyste and not can_tx_transmettre_ggr and not can_tx_retour_gestionnaire and not can_tx_approuver and not can_tx_refuser and not can_tx_liberer_fonds %}
          <span class="text-muted">Aucune action disponible à ce stade.</span>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-header">Informations</div>
      <div class="card-body">
        <dl class="row mb-0">
          <dt class="col-sm-4">Client</dt><dd class="col-sm-8">{{ dossier.client.username }}</dd>
          <dt class="col-sm-4">Produit</dt><dd class="col-sm-8">{{ dossier.produit }}</dd>
          <dt class="col-sm-4">Montant</dt><dd class="col-sm-8">{{ dossier.montant }}</dd>
          <dt class="col-sm-4">Statut (agent)</dt><dd class="col-sm-8"><span class="badge text-bg-secondary">{{ dossier.get_statut_agent_display }}</span></dd>
          <dt class="col-sm-4">Statut (client)</dt><dd class="col-sm-8"><span class="badge text-bg-secondary">{{ dossier.get_statut_client_display }}</span></dd>
          <dt class="col-sm-4">Soumission</dt><dd class="col-sm-8">{{ dossier.date_soumission|date:"d/m/Y H:i" }}</dd>
          <dt class="col-sm-4">Dernière MAJ</dt><dd class="col-sm-8">{{ dossier.date_maj|date:"d/m/Y H:i" }}</dd>
        </dl>
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-header">Pièces jointes</div>
      <div class="card-body">
        {% if pieces %}
          <ul class="list-group list-group-flush">
            {% for p in pieces %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-semibold">{{ p.get_type_piece_display }} <span class="text-muted">• {{ p.upload_at|date:"d/m/Y H:i" }}</span></div>
                  <div class="small text-muted">Taille: {{ p.taille }} octets</div>
                </div>
                <a class="btn btn-sm btn-outline-secondary" href="{{ p.fichier.url }}" target="_blank">Télécharger</a>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted mb-0">Aucune pièce jointe.</p>
        {% endif %}
        {% if can_upload %}
          <hr class="my-3" />
          <form method="post" action="" enctype="multipart/form-data" class="row g-2 align-items-end">
            {% csrf_token %}
            <input type="hidden" name="action" value="upload_piece" />
            <div class="col-sm-5">
              <label class="form-label">Fichier</label>
              <input type="file" name="fichier" class="form-control" accept=".pdf,.jpg,.jpeg,.png" required />
            </div>
            <div class="col-sm-4">
              <label class="form-label">Type de pièce</label>
              <select name="type_piece" class="form-select">
                <option value="AUTRE">Autre</option>
                <option value="CNI">Carte Nationale d'Identité</option>
                <option value="FICHE_PAIE">Fiche de paie</option>
                <option value="RELEVE_BANCAIRE">Relevé bancaire</option>
              </select>
            </div>
            <div class="col-sm-3">
              <button type="submit" class="btn btn-primary w-100">Téléverser</button>
            </div>
          </form>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-header">Commentaires</div>
      <div class="card-body">
        <form method="post" class="mb-3">
          {% csrf_token %}
          <input type="hidden" name="action" value="add_comment" />
          <div class="mb-2">
            <label class="form-label">Ajouter un commentaire</label>
            <textarea name="message" class="form-control" rows="2" placeholder="Votre message..."></textarea>
          </div>
          <button type="submit" class="btn btn-primary btn-sm">Publier</button>
        </form>
        {% if commentaires %}
          <ul class="list-group list-group-flush">
            {% for c in commentaires %}
              <li class="list-group-item">
                <div class="small text-muted">{{ c.created_at|date:"d/m/Y H:i" }} • {{ c.auteur.username }}</div>
                <div>{{ c.message }}</div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted mb-0">Aucun commentaire pour l’instant.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-header">Historique</div>
      <div class="card-body">
        {% if journal %}
          <ul class="list-group list-group-flush">
            {% for j in journal %}
              <li class="list-group-item">
                <div class="small text-muted">{{ j.timestamp|date:"d/m/Y H:i" }} • {% if j.acteur %}{{ j.acteur.username }}{% else %}Système{% endif %}</div>
                <div>
                  <strong>{{ j.action }}</strong> — {{ j.de_statut }} → {{ j.vers_statut }}
                </div>
                {% if j.commentaire_systeme %}
                  <div class="text-muted small">{{ j.commentaire_systeme }}</div>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted mb-0">Aucun historique pour l’instant.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Inclure le modal de retour client -->
{% if can_tx_retour_client %}
  {% include "suivi_demande/modal_retour_client.html" %}
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    // Configurer l'action du formulaire avec l'ID du dossier
    const modal = document.getElementById('retourClientModal');
    const form = document.getElementById('retourClientForm');
    
    modal.addEventListener('show.bs.modal', function(event) {
      const button = event.relatedTarget;
      const dossierId = button.getAttribute('data-dossier-id');
      form.action = "{% url 'transition_dossier' 0 'retour_client' %}".replace('0', dossierId);
    });
  });
  </script>
{% endif %}

{% endblock %}
